---
import { encryptData } from '../js/encryption.js';
var API_ENDPOINT = import.meta.env.API_ENDPOINT;
const url = Astro.url.searchParams.get('p') || '/dash';
let code_pram = Astro.url.searchParams.get('code');
let state_pram = Astro.url.searchParams.get('state');
let url_obj = new URL(url, "https://fantasybot.xyz");
let path_redirect = url_obj.pathname + url_obj.search + url_obj.hash;
if (code_pram && state_pram) {
    console.log(API_ENDPOINT+'/login')
    let rep = await fetch(API_ENDPOINT+'/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            code: code_pram,
            redirect_uri: Astro.url.origin + Astro.url.pathname
        })
    });
    let json_data = await rep.json();
    if (!json_data.login) {
        return Astro.redirect('/');
    }
    Astro.cookies.set('TOKEN', encryptData(json_data.data));
    return Astro.redirect(atob(state_pram));
} else {
    if (Astro.cookies.get('TOKEN')) {
        return Astro.redirect('/dash');
    }
    return Astro.redirect('https://discord.com/oauth2/authorize?client_id=931353470353674291&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%2Flogin&scope=identify+guilds&state=' + btoa(path_redirect));
}

---